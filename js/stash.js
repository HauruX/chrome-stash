function Stash(){this.storage=null;this.listAmount=0;var a=this;this.reqGetStorage(function(b){chrome.browserAction.setPopup({popup:"popup.html"});a.storage=b.storage;a.listAmount=a.storage.children?a.storage.children.length:0;a._refreshBadgeText(0)});chrome.bookmarks.onCreated.addListener(this.onChanged.bind(this));chrome.bookmarks.onChanged.addListener(this.onChanged.bind(this));chrome.bookmarks.onMoved.addListener(this.onChanged.bind(this));chrome.bookmarks.onRemoved.addListener(this.onChanged.bind(this))}Stash.prototype={constructor:Stash,reqSearchStorage:function(a){chrome.bookmarks.getTree(function(e){var g=e[0].children[1];var d=g.children,f=null,c=chrome.i18n.getMessage("storage");for(var b=0;b<d.length;b++){if(d[b].title==c){f=d[b];break}}a&&a({storage:f,obkmk:g,obkmktree:d})})},reqGetStorage:function(a){var b=this;this.reqSearchStorage(function(c){if(c.storage){a&&a(c)}else{chrome.bookmarks.create({parentId:c.obkmk.id,title:chrome.i18n.getMessage("storage")},function(d){a&&a(c)})}})},onChanged:function(){var a=this;this.reqGetStorage(function(b){a.storage=b.storage;a.listAmount=a.storage.children.length;a._refreshBadgeText(0)})},_updateStorage:function(){this.onChanged()},_getTime:function(){var a=new Date();return a.toISOString().slice(5,16).replace("T"," ")},_genStashTitle:function(b,a){var c=b[a].title;c=c.length>32?c.slice(0,29)+"...":c;return{time:this._getTime(),title:c}},splitTitle:function(b){var a=[];a.push(b.slice(0,11));a.push(b.slice(11));return a},_isSafeTab:function(a){return/^chrome:\/\//.test(a.url)||a.pinned},_isSafeWindow:function(b){for(var a=0;a<b.length;a++){if(this._isSafeTab(b[a])){return true}}return false},_getFirstUnsafeTabIndex:function(b){for(var a=0;a<b.length;a++){if(!this._isSafeTab(b[a])){return a}}return -1},_refreshBadgeText:function(a){this.listAmount+=a;chrome.browserAction.setBadgeText({text:this.listAmount==0?"":this.listAmount.toString()})},htmlspecialchars:function(a){return a.replace(/>/g,"&gt;").replace(/</g,"&lt;").replace(/"/g,"&quot;")},stashTabs:function(d,c){var a=this._getFirstUnsafeTabIndex(d);if(a<0){c&&c({count:0})}if(!this._isSafeWindow(d)){chrome.tabs.create({url:"chrome://newtab/"})}var b=this._genStashTitle(d,a);var f=0;var e=this;chrome.bookmarks.create({parentId:e.storage.id,title:b.time+" "+b.title},function(h){for(var g=a;g<d.length;g++){if(!e._isSafeTab(d[g])){chrome.bookmarks.create({parentId:h.id,title:d[g].title,url:d[g].url});chrome.tabs.remove(d[g].id);f++}}e._refreshBadgeText(1);e._updateStorage();c&&c({info:b,count:f,id:h.id})})},unstashTabs:function(e,d,b){var c=this;try{chrome.bookmarks.getChildren(e,function(h){if(d){var g=[];for(var f=0;f<h.length;f++){g.push(h[f].url)}chrome.bookmarks.removeTree(e);chrome.windows.create({url:g})}else{for(var f=0;f<h.length;f++){chrome.tabs.create({url:h[f].url})}chrome.bookmarks.removeTree(e)}})}catch(a){}finally{c._refreshBadgeText(-1);c._updateStorage();b&&b()}},getFavicos:function(c,a){var b=this;chrome.bookmarks.getChildren(c,function(e){var d=e.map(function(f){return{title:f.title,url:"chrome://favicon/"+f.url}});a&&a(d.slice(0,8))})}};function getModel(b){var a={btnStash:chrome.i18n.getMessage("btnStash"),listTitle:chrome.i18n.getMessage("listTitle"),empty:b.storage.children.length==0?chrome.i18n.getMessage("empty"):false,list:b.storage.children.map(function(d){var c=b.splitTitle(d.title);return{id:d.id,stitle:c[1],stime:c[0],count:d.children?d.children.length:"?"}})};return a}function main(){var a=new Stash();chrome.extension.onRequest.addListener(function(e,d,c){switch(e.type){case"stash":a.stashTabs(e.tabs,function(f){if(f.count>0){c({status:"ok",list:[{stitle:f.info.title,stime:f.info.time,id:f.id,count:f.count}]})}else{c({status:"fail"})}});break;case"unstash":a.unstashTabs(e.id,e.newW,function(){c({status:"ok"})});break;case"model":var b=getModel(a);c({status:"ok",model:b});break;case"favico":a.getFavicos(e.id,function(f){c({status:"ok",favlist:f})});break}})}main();